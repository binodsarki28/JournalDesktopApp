@page "/journal"
@using JournalApplicaton.Model
@using JournalApplicaton.Services
@inject UserSessionService Session
@inject IJournalService JournalService

<div class="container py-4">
    <h3>Journal Management</h3>

    <button class="btn btn-success mb-3" @onclick="CreateTodayJournal">
        + Create Journal Today
    </button>

    @if (!string.IsNullOrEmpty(todayMessage))
    {
        <div class="alert alert-info">@todayMessage</div>
    }

    <table class="table table-hover">
        <thead>
            <tr>
                <th>Date</th>
                <th>Title</th>
                <th>Mood</th>
                <th>Words</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var j in journals)
            {
                <tr>
                    <td>@j.EntryDate.ToShortDateString()</td>
                    <td>@j.Title</td>
                    <td>@j.PrimaryMood</td>
                    <td>@j.WordCount</td>
                    <td>
                        <button class="btn btn-sm btn-info me-1"
                                @onclick="() => ViewJournalDetails(j)">
                            View
                        </button>

                        <button class="btn btn-sm btn-warning me-1"
                                @onclick="() => EditJournal(j)">
                            Edit
                        </button>

                        <button class="btn btn-sm btn-danger"
                                @onclick="() => ConfirmDelete(j)">
                            Delete
                        </button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

<!-- ================= CREATE / EDIT MODAL ================= -->
@if (showModal)
{
    <div class="modal fade show d-block" style="background:rgba(0,0,0,0.6);">
        <div class="modal-dialog modal-lg">
            <div class="modal-content p-4">
                <h5>@(journalToEdit == null ? "Create Journal" : "Edit Journal")</h5>

                <input class="form-control mb-2"
                       placeholder="Title"
                       @bind="journalTitle" />

                <textarea class="form-control mb-2"
                          rows="6"
                          placeholder="Content"
                          @bind="journalContent"></textarea>

                <input class="form-control mb-2"
                       placeholder="Primary Mood"
                       @bind="journalPrimaryMood" />

                <input class="form-control mb-2"
                       placeholder="Secondary moods (comma separated)"
                       @bind="secondaryMoodInput" />

                <input class="form-control mb-2"
                       placeholder="Tags"
                       @bind="tagsInput" />

                @if (!string.IsNullOrEmpty(formMessage))
                {
                    <div class="alert alert-danger">@formMessage</div>
                }

                <div class="mt-3">
                    <button class="btn btn-success me-2" @onclick="SaveJournal">Save</button>
                    <button class="btn btn-secondary" @onclick="CloseModal">Close</button>
                </div>
            </div>
        </div>
    </div>
}

<!-- ================= VIEW MODAL ================= -->
@if (showViewModal)
{
    <div class="modal fade show d-block" style="background:rgba(0,0,0,0.6);">
        <div class="modal-dialog modal-lg">
            <div class="modal-content p-4">
                <h5>Journal Details</h5>

                <p><strong>Date:</strong> @journalTitleDate.ToShortDateString()</p>
                <p><strong>Title:</strong> @journalTitle</p>

                <p><strong>Content:</strong></p>
                <p>@journalContent</p>

                <p><strong>Primary Mood:</strong> @journalPrimaryMood</p>
                <p><strong>Secondary Moods:</strong> @secondaryMoodInput</p>
                <p><strong>Tags:</strong> @tagsInput</p>
                <p><strong>Word Count:</strong>@wordCount</p>

                <button class="btn btn-secondary mt-2" @onclick="CloseViewModal">
                    Close
                </button>
            </div>
        </div>
    </div>
}

<!-- ================= DELETE CONFIRM ================= -->
@if (showDeleteConfirm)
{
    <div class="modal fade show d-block" style="background:rgba(0,0,0,0.6);">
        <div class="modal-dialog">
            <div class="modal-content p-4">
                <h5>Are you sure you want to delete?</h5>

                <button class="btn btn-danger me-2" @onclick="DeleteJournal">
                    Yes, Delete
                </button>

                <button class="btn btn-secondary"
                        @onclick="() => showDeleteConfirm = false">
                    Cancel
                </button>
            </div>
        </div>
    </div>
}

@code {

    List<JournalDisplayModel> journals = new();

    JournalDisplayModel? journalToEdit;
    JournalDisplayModel? journalToDelete;

    bool showModal = false;
    bool showViewModal = false;
    bool showDeleteConfirm = false;

    string todayMessage = "";
    string formMessage = "";

    string journalTitle = "";
    string journalContent = "";
    string journalPrimaryMood = "";

    // 🔑 UI-safe string inputs
    string secondaryMoodInput = "";
    string tagsInput = "";

    int wordCount;

    DateTime journalTitleDate;

    protected override async Task OnInitializedAsync()
        => await LoadJournals();

    private async Task LoadJournals()
    {
        var (list, _) =
            await JournalService.GetAllJournalsByUserAsync(
                Session.CurrentUser!.UserId);

        journals = list;

        var hasToday =
            await JournalService.HasJournalForTodayAsync(
                Session.CurrentUser!.UserId);

        todayMessage = hasToday
            ? "You already created a journal for today."
            : "";
    }

    private async void CreateTodayJournal()
    {
        if (await JournalService.HasJournalForTodayAsync(
                Session.CurrentUser!.UserId))
        {
            todayMessage = "You already created a journal for today.";
            return;
        }

        journalToEdit = null;
        showModal = true;
    }

    private async void EditJournal(JournalDisplayModel j)
    {
        journalToEdit = j;

        var fullJournal =
            await JournalService.GetJournalByDateAsync(
                Session.CurrentUser!.UserId,
                j.EntryDate);

        if (fullJournal != null)
        {
            journalTitle = fullJournal.Title;
            journalContent = fullJournal.Content;
            journalPrimaryMood = fullJournal.PrimaryMood;

            secondaryMoodInput =
                string.Join(", ", fullJournal.SecondaryMoods);

            tagsInput =
                string.Join(", ", fullJournal.Tags);
        }

        formMessage = "";
        showModal = true;
    }

    private void CloseModal()
    {
        showModal = false;
        journalToEdit = null;
        formMessage = "";
    }

    private async Task SaveJournal()
    {
        if (string.IsNullOrWhiteSpace(journalTitle) ||
            string.IsNullOrWhiteSpace(journalContent))
        {
            formMessage = "Title and content are required.";
            return;
        }

        var model = new JournalViewModel
        {
            EntryDate = journalToEdit != null
                ? journalToEdit.EntryDate
                : DateTime.Today,

            Title = journalTitle,
            Content = journalContent,
            PrimaryMood = journalPrimaryMood,

            SecondaryMoods = secondaryMoodInput
                .Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries)
                .ToList(),

            Tags = tagsInput
                .Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries)
                .ToList()
        };

        var result =
            await JournalService.AddOrUpdateJournalAsync(
                Session.CurrentUser!.UserId, model);

        if (!result.Success)
        {
            formMessage = result.ErrorMessage!;
            return;
        }

        showModal = false;
        journalToEdit = null;
        await LoadJournals();
    }

    private async Task ViewJournalDetails(JournalDisplayModel j)
    {
        var fullJournal =
            await JournalService.GetJournalByDateAsync(
                Session.CurrentUser!.UserId,
                j.EntryDate);

        if (fullJournal != null)
        {
            journalTitle = fullJournal.Title;
            journalContent = fullJournal.Content;
            journalPrimaryMood = fullJournal.PrimaryMood;

            secondaryMoodInput =
                string.Join(", ", fullJournal.SecondaryMoods);

            tagsInput =
                string.Join(", ", fullJournal.Tags);

            wordCount = fullJournal.WordCount;

            journalTitleDate = fullJournal.EntryDate;
            showViewModal = true;
        }
    }

    private void CloseViewModal()
        => showViewModal = false;

    private void ConfirmDelete(JournalDisplayModel j)
    {
        journalToDelete = j;
        showDeleteConfirm = true;
    }

    private async Task DeleteJournal()
    {
        if (journalToDelete == null) return;

        await JournalService.DeleteJournalAsync(
            Session.CurrentUser!.UserId,
            journalToDelete.JournalId);

        showDeleteConfirm = false;
        await LoadJournals();
    }
}
