@page "/journal"
@using JournalApplicaton.Model
@using JournalApplicaton.Entities
@using JournalApplicaton.Services

@inject IJournalService JournalService
@inject UserSessionService Session

<div class="container py-4">

    <h3>Journal Management</h3>

    @if (todayJournalExists)
    {
        <div class="alert alert-info">
            You already wrote today’s journal.
        </div>
    }
    else
    {
        <button class="btn btn-success mb-3"
                @onclick="CreateTodayJournal">
            + Create Journal Today
        </button>
    }

    <table class="table table-hover">
        <thead>
            <tr>
                <th>Date</th>
                <th>Title</th>
                <th>Mood</th>
                <th>Words</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var j in journals)
            {
                <tr>
                    <td>@j.EntryDate.ToShortDateString()</td>
                    <td>@j.Title</td>
                    <td>@j.PrimaryMood</td>
                    <td>@j.WordCount</td>
                    <td>
                        <button class="btn btn-sm btn-info"
                                @onclick="() => ViewJournal(j)">
                            View
                        </button>
                        <button class="btn btn-sm btn-primary"
                                @onclick="() => EditJournal(j)">
                            Edit
                        </button>
                        <button class="btn btn-sm btn-danger"
                                @onclick="() => ConfirmDelete(j)">
                            Delete
                        </button>
                    </td>
                </tr>
            }
        </tbody>
    </table>

    <!-- Pagination -->
    <nav>
        <ul class="pagination">
            @for (int i = 1; i <= totalPages; i++)
            {
                <li class="page-item @(i == currentPage ? "active" : "")">
                    <button class="page-link"
                            @onclick="() => GoToPage(i)">
                        @i
                    </button>
                </li>
            }
        </ul>
    </nav>
</div>

@if (showModal && fullJournal != null)
{
    <div class="modal fade show d-block"
         style="background:rgba(0,0,0,.6)">
        <div class="modal-dialog modal-lg">
            <div class="modal-content p-4">

                @if (isViewMode)
                {
                    <h4>@fullJournal.Title</h4>
                    <p class="text-muted">
                        @fullJournal.EntryDate.ToShortDateString() |
                        @fullJournal.PrimaryMood |
                        @fullJournal.WordCount words
                    </p>

                    <p><strong>Tags:</strong> @fullJournal.Tags</p>
                    <hr />
                    <p style="white-space:pre-line">
                        @fullJournal.Content
                    </p>
                }
                else
                {
                    <input class="form-control mb-2"
                           placeholder="Title"
                           @bind="journalTitle" />

                    <textarea class="form-control mb-2"
                              rows="6"
                              @bind="journalContent"></textarea>

                    <input class="form-control mb-2"
                           placeholder="Primary Mood"
                           @bind="journalPrimaryMood" />

                    <input class="form-control mb-2"
                           placeholder="Secondary moods (comma separated)"
                           @bind="journalSecondaryMoods" />

                    <input class="form-control mb-2"
                           placeholder="Tags"
                           @bind="journalTags" />

                    <button class="btn btn-success"
                            @onclick="SaveJournal">
                        Save
                    </button>
                }

                <button class="btn btn-secondary mt-2"
                        @onclick="CloseModal">
                    Close
                </button>
            </div>
        </div>
    </div>
}

@if (showDeleteConfirm)
{
    <div class="modal fade show d-block"
         style="background:rgba(0,0,0,.6)">
        <div class="modal-dialog">
            <div class="modal-content p-4">
                <h5>Are you sure?</h5>
                <button class="btn btn-danger"
                        @onclick="DeleteJournal">
                    Yes, Delete
                </button>
                <button class="btn btn-secondary"
                        @onclick="() => showDeleteConfirm = false">
                    Cancel
                </button>
            </div>
        </div>
    </div>
}

@code {
    List<JournalDisplayModel> journals = new();
    Journal? fullJournal;

    bool showModal, isViewMode, showDeleteConfirm, todayJournalExists;
    int currentPage = 1, pageSize = 10, totalPages;

    JournalDisplayModel? journalToDelete;

    string journalTitle = "", journalContent = "",
           journalPrimaryMood = "", journalSecondaryMoods = "", journalTags = "";

    protected override async Task OnInitializedAsync()
    {
        await LoadJournals();
    }

    async Task LoadJournals()
    {
        var (list, total) =
            await JournalService.GetAllJournalsByUserAsync(
                Session.CurrentUser!.UserId,
                currentPage,
                pageSize);

        journals = list;
        totalPages = (int)Math.Ceiling(total / (double)pageSize);

        todayJournalExists =
            await JournalService.HasJournalForTodayAsync(
                Session.CurrentUser!.UserId);
    }

    async Task ViewJournal(JournalDisplayModel j)
    {
        fullJournal = await JournalService.GetJournalByDateAsync(
            Session.CurrentUser!.UserId, j.EntryDate);

        isViewMode = true;
        showModal = true;
    }

    async Task EditJournal(JournalDisplayModel j)
    {
        fullJournal = await JournalService.GetJournalByDateAsync(
            Session.CurrentUser!.UserId, j.EntryDate);

        journalTitle = fullJournal!.Title;
        journalContent = fullJournal.Content;
        journalPrimaryMood = fullJournal.PrimaryMood;
        journalSecondaryMoods =
            $"{fullJournal.SecondaryMood1},{fullJournal.SecondaryMood2}";
        journalTags = fullJournal.Tags ?? "";

        isViewMode = false;
        showModal = true;
    }

    async Task SaveJournal()
    {
        var moods = journalSecondaryMoods.Split(',', StringSplitOptions.TrimEntries);

        await JournalService.AddOrUpdateJournalAsync(
            Session.CurrentUser!.UserId,
            new JournalViewModel
            {
                EntryDate = fullJournal!.EntryDate,
                Title = journalTitle,
                Content = journalContent,
                PrimaryMood = journalPrimaryMood,
                SecondaryMood1 = moods.ElementAtOrDefault(0),
                SecondaryMood2 = moods.ElementAtOrDefault(1),
                Tags = journalTags
            });

        showModal = false;
        await LoadJournals();
    }

    void CreateTodayJournal()
    {
        fullJournal = new Journal { EntryDate = DateTime.Today };
        journalTitle = journalContent = journalPrimaryMood =
        journalSecondaryMoods = journalTags = "";
        isViewMode = false;
        showModal = true;
    }

    void ConfirmDelete(JournalDisplayModel j)
    {
        journalToDelete = j;
        showDeleteConfirm = true;
    }

    async Task DeleteJournal()
    {
        await JournalService.DeleteJournalAsync(
            Session.CurrentUser!.UserId,
            journalToDelete!.JournalId);

        showDeleteConfirm = false;
        await LoadJournals();
    }

    void GoToPage(int p)
    {
        currentPage = p;
        _ = LoadJournals();
    }

    void CloseModal() => showModal = false;
}
