@page "/dashboard"
@using JournalApplicaton.Services

@inject IJournalService JournalService
@inject UserSessionService Session
@inject IJSRuntime JS

<h3 class="mb-4">📊 Dashboard</h3>

@if (analytics == null)
{
    <p>Loading analytics...</p>
}
else
{
    <div class="row mb-4 text-center">
        <div class="col-md-4">
            <div class="card p-3 shadow">
                <h5>🔥 Current Streak</h5>
                <h2>@analytics.CurrentStreak</h2>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card p-3 shadow">
                <h5>🏆 Longest Streak</h5>
                <h2>@analytics.LongestStreak</h2>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card p-3 shadow">
                <h5>❌ Missed Days</h5>
                <h2>@analytics.MissedDays</h2>
            </div>
        </div>
    </div>

    <!-- Charts row -->
    <div class="row mb-5 justify-content-center">
        <div class="col-md-5 mb-4">
            <div class="card p-3 shadow">
                <h5 class="text-center mb-3">Mood Distribution</h5>
                <canvas id="moodChart" width="400" height="300"></canvas>
            </div>
        </div>

        <div class="col-md-5 mb-4">
            <div class="card p-3 shadow">
                <h5 class="text-center mb-3">Tag Distribution</h5>
                <canvas id="tagChart" width="400" height="300"></canvas>
            </div>
        </div>
    </div>

    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="card p-3 shadow">
                <h5 class="text-center mb-3">Word Count Trend</h5>
                <canvas id="wordTrendChart" width="800" height="300"></canvas>
            </div>
        </div>
    </div>
}

@code {
    private JournalAnalyticsResult? analytics;
    private bool chartsRendered = false;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            analytics = await JournalService
                .GetAnalyticsResultAsync(Session.CurrentUser!.UserId);

            StateHasChanged();
            return;
        }

        if (analytics != null && !chartsRendered)
        {
            chartsRendered = true;

            await JS.InvokeVoidAsync(
                "renderDashboardCharts",
                analytics.MoodDistribution,
                analytics.TagDistribution,
                analytics.WordCountTrend
            );
        }
    }
}

<script>
    window.renderDashboardCharts = (moodData, tagData, wordCountData) => {
        window.renderMoodChart(moodData);
        window.renderTagChart(tagData);
        window.renderWordCountChart(wordCountData);
    };

    function generateColors(count) {
        const colors = [];
        for (let i = 0; i < count; i++) {
            colors.push(`hsl(${Math.random() * 360}, 70%, 60%)`);
        }
        return colors;
    }

    function getTotal(data) {
        return Object.values(data).reduce((a, b) => a + b, 0);
    }

    function formatLabel(label, value, total) {
        const percentage = ((value / total) * 100).toFixed(1);
        return `**${label}**: ${value} entries (${percentage}%)`;
    }

    // Render Pie Chart with visible labels on chart
    function renderPieChart(canvasId, data) {
        const ctx = document.getElementById(canvasId);
        if (!ctx) return;

        const total = getTotal(data);

        new Chart(ctx, {
            type: 'pie',
            data: {
                labels: Object.keys(data),
                datasets: [{
                    data: Object.values(data),
                    backgroundColor: generateColors(Object.keys(data).length)
                }]
            },
            options: {
                responsive: false,
                plugins: {
                    legend: {
                        position: 'right',
                        labels: {
                            font: { size: 14 },
                            generateLabels: function(chart) {
                                const dataset = chart.data.datasets[0];
                                return chart.data.labels.map((label, i) => ({
                                    text: `${label}: ${dataset.data[i]} (${((dataset.data[i]/total)*100).toFixed(1)}%)`,
                                    fillStyle: dataset.backgroundColor[i],
                                    strokeStyle: dataset.backgroundColor[i],
                                    hidden: false,
                                    index: i
                                }));
                            }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const value = context.raw;
                                const percentage = ((value / total) * 100).toFixed(1);
                                return `${context.label}: ${value} (${percentage}%)`;
                            }
                        }
                    },
                    datalabels: {
                        anchor: 'center',
                        align: 'center',
                        color: 'white',
                        font: { weight: 'bold', size: 14 },
                        formatter: function(value, context) {
                            const percentage = ((value / total) * 100).toFixed(1);
                            return `${context.chart.data.labels[context.dataIndex]}\n${value} (${percentage}%)`;
                        }
                    }
                },
            },
            plugins: [ChartDataLabels] // make sure you include ChartDataLabels plugin
        });
    }

    window.renderMoodChart = (data) => renderPieChart('moodChart', data);
    window.renderTagChart = (data) => renderPieChart('tagChart', data);

    // Word count line chart (unchanged)
    window.renderWordCountChart = (data) => {
        const ctx = document.getElementById('wordTrendChart');
        if (!ctx) return;

        new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.map(x => new Date(x.date).toLocaleDateString()),
                datasets: [{
                    label: 'Word Count',
                    data: data.map(x => x.wordCount),
                    tension: 0.3,
                    borderColor: '#007bff',
                    backgroundColor: 'rgba(0,123,255,0.1)',
                    fill: true
                }]
            },
            options: {
                responsive: false,
                plugins: {
                    legend: { position: 'top', labels: { font: { size: 14 } } },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `${context.dataset.label}: ${context.raw}`;
                            }
                        }
                    }
                },
                scales: {
                    x: { title: { display: true, text: 'Date' } },
                    y: { title: { display: true, text: 'Word Count' }, beginAtZero: true }
                }
            }
        });
    };
</script>

